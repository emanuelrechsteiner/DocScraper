---
url: https://supabase.com/blog/mfa-auth-via-rls
scraped_at: 2025-05-25T09:09:04.438908
title: Multi-factor Authentication via Row Level Security Enforcement
---

  1. We use cookies to collect data and improve our services. [Learn more](https://supabase.com/privacy#8-cookies-and-similar-technologies-used-on-our-european-services)
[Learn more](https://supabase.com/privacy#8-cookies-and-similar-technologies-used-on-our-european-services)•Privacy settings
Accept Opt out Privacy settings


[![Supabase Logo](https://supabase.com/_next/image?url=https%3A%2F%2Ffrontend-assets.supabase.com%2Fwww%2Fd218d9190b87%2F_next%2Fstatic%2Fmedia%2Fsupabase-logo-wordmark--light.daaeffd3.png&w=256&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG)![Supabase Logo](https://supabase.com/_next/image?url=https%3A%2F%2Ffrontend-assets.supabase.com%2Fwww%2Fd218d9190b87%2F_next%2Fstatic%2Fmedia%2Fsupabase-logo-wordmark--dark.b36ebb5f.png&w=256&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG)](https://supabase.com/)
  * Product 
  * Developers 
  * [Enterprise](https://supabase.com/enterprise)
  * [Pricing](https://supabase.com/pricing)
  * [Docs](https://supabase.com/docs)
  * [Blog](https://supabase.com/blog)


[83.3K](https://github.com/supabase/supabase)[Sign in](https://supabase.com/dashboard)[Start your project](https://supabase.com/dashboard)
Open main menu
[Back](https://supabase.com/blog)
[Blog](https://supabase.com/blog)
# Multi-factor Authentication via Row Level Security Enforcement
14 Dec 2022
•
7 minute read
[![Joel Lee avatar](https://supabase.com/_next/image?url=https%3A%2F%2Fgithub.com%2Fj0.png&w=96&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG)Joel LeeEngineering](https://github.com/j0)
[![Kang Ming Tay avatar](https://supabase.com/_next/image?url=https%3A%2F%2Fgithub.com%2Fkangmingtay.png&w=96&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG)Kang Ming TayEngineering](https://github.com/kangmingtay)
[![Stojan Dimitrovski avatar](https://supabase.com/_next/image?url=https%3A%2F%2Fgithub.com%2Fhf.png&w=96&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG)Stojan DimitrovskiEngineering](https://github.com/hf)
![Multi-factor Authentication via Row Level Security Enforcement](https://supabase.com/_next/image?url=%2Fimages%2Fblog%2Flw6-auth%2Fmfa-banner.jpg&w=3840&q=100&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG)
Today, we’re releasing Multi Factor Authentication for everyone.
Additionally, in preparation for releasing SAML, we're "dogfooding" the feature with the introduction of Single Sign On (SSO) on our dashboard. Contact us at growth@supabase.com if you want to [enable this on your Enterprise plan](https://supabase.com/docs/guides/platform/sso).
## What is MFA?[#](https://supabase.com/blog/mfa-auth-via-rls#what-is-mfa)
Multi-factor authentication (MFA), sometimes called two-factor authentication (2FA), adds an additional layer of security to your application by letting you verify users’ identity through extra steps. This typically consists of something you know, like a password, and something you have, like an authenticator application. We built MFA in response to customer requests - developers wanted enhanced security - be it for compliance, client requirements, or simply for peace of mind. As such, we started by building MFA support for Time-Based One Time Passwords (TOTP).
## An Overview of TOTP[#](https://supabase.com/blog/mfa-auth-via-rls#an-overview-of-totp)
[TOTP](https://www.rfc-editor.org/rfc/rfc6238) works by generating a unique, one-time password that is valid for a limited amount of time, usually 30 seconds or less. This password is generated using a shared secret key that is known only to the device and Supabase Auth, along with the current time. To exchange the shared secret key, a user scans a QR code generated by the server in order to establish a connection. The QR code can be represented by a URI which conforms to the [Google Authenticator Key URI format](https://github.com/google/google-authenticator/wiki/Key-Uri-Format):
`
1
otpauth://totp/supabase.io:j@supacats.io?algorithm=SHA1&digits=6&issuer=supabase.io&period=30&secret=BFSXQHFB2BGAZIOQWCDBJUF7B54A52JQ
`
The first portion of `otpauth://totp/supabase.io` describes the protocol and issuer while `j@supacats.io` refers to the user. The remaining parameters refer to specifics around OTP generation. In this case, the OTP code is generated using a SHA1 hash of the secret combined with the timestamp and the OTP code is valid for `30s`
In the event that the user faces difficulties entering a QR code the user can also opt to manually type the secret into the authenticator device.
## MFA Flows: Enrollment and Verification[#](https://supabase.com/blog/mfa-auth-via-rls#mfa-flows-enrollment-and-verification)
An MFA flow can be broken into two key steps: Enrollment and Verification. During the _Enrollment_ process Supabase Auth exchanges a randomly generated secret with the user’s authenticator application. During the _Verification_ process, the device makes use of the timestamp together with the secret to produce a six digit code that the server can verify.
![Flowchart of an MFA flow](https://supabase.com/_next/image?url=%2Fimages%2Fblog%2Flw6-auth%2Fmfa-flow.png&w=3840&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG) _Enrollment_
To generate a QR code, call the `/enroll` endpoint which returns an SVG encoded QR and the secret. Thereafter, create a challenge by calling the `/challenge` endpoint. Once the user has entered the six digit TOTP code generated by their authenticator app, call the`/verify` endpoint with the corresponding factor and challenge details.
You might wonder: why the need for the "challenge" step? This step creates an interval between MFA initiation and the action of making a verification. This is useful in cases like Yubikey authentication where a user might need to request a challenge before placing their finger on the device.
![MFA Enrollment Flow](https://supabase.com/_next/image?url=%2Fimages%2Fblog%2Flw6-auth%2Fenrollment_flow.png&w=3840&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG) _Overview of Enrollment Flow_
**Verification**
On subsequent logins attempts, redirect a user to an MFA verification after they have completed the conventional sign in process. On the verification page, wait for the user to enter the six digit OTP code from the authenticator application and then call the`/challenge` endpoint followed by the `/verify` endpoint. If a correct code is submitted, a JWT will be created with a few additional fields.
![MFA Verification Flow](https://supabase.com/_next/image?url=%2Fimages%2Fblog%2Flw6-auth%2Fverify_flow.png&w=3840&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG) _Overview of Verification Flow_
## Enforcement via Row Level Security[#](https://supabase.com/blog/mfa-auth-via-rls#enforcement-via-row-level-security)
Using MFA without enforcing it is like buying an expensive door and never locking it. We love Postgres RLS at Supabase. To support RLS integration, JWTs issued by Supabase Auth now contain two additional pieces of information:
  1. An Authenticator Assurance Level (AAL) claim. Use this to quickly identify the level of identity checks the user has performed. `aal1` is reserved for conventional sign in, while `aal2` is issued only after the user has verified with an additional factor.
  2. An Authenticator Method Reference (AMR) claim. Use this to identify all of the authentication methods used by the user. This is also useful if you wish to implement step-up login scenarios.


`
1
{
2
 "sub": "8802c1d6-c555-46e3-aacd-b61198b058d9",
3
 "email": "j0@supacats.io",
4
 "aud": "authenticated",
5
 "exp": 1670929371,
6
 "aal": "aal2",
7
 "amr": [
8
  {
9
   "method": "password",
10
   "timestamp": 1670924394
11
  },
12
  {
13
   "method": "totp",
14
   "timestamp": 1670925771
15
  }
16
 ],
17
 // ...
18
}
`
The information encoded in these claims can be used for both full enforcement and partial enforcement across database queries.
`
1
create policy "Enforce MFA for all end users."
2
 on table_name
3
 as restrictive
4
 to authenticated
5
 using ( (select auth.jwt()->>'aal') = 'aal2' );
`
_Enforce MFA for all end users_
`
1
create policy "Allow access on table only if user has gone through MFA"
2
 on table_name
3
 as restrictive -- very important!
4
 to authenticated
5
 using (
6
  array[auth.jwt()->>'aal'] <@ (
7
   select
8
     case
9
      when count(id) > 0 then array['aal2']
10
      else array['aal1', 'aal2']
11
     end as aal
12
    from auth.mfa_factors
13
    where (select auth.uid()) = user_id and status = 'verified'
14
  ));
`
_Enforce MFA for selected users_
Note that both RLS policies are restrictive. By default, overlapping policies in PostgreSQL are permissive rather than restrictive. This means that RLS policies are combined with an `OR` clause and only one policy needs to pass in order for a row to be operated on. Therefore, we set RLS policies as restrictive to enforce the checks from multiple policies.
Be mindful of your user’s preference, though. If a user has enabled MFA, they are expecting a higher level of security for their account. Consequently, we recommend that developers enforce MFA across all operations if a user has MFA enabled. You can check out [our MFA guide](https://supabase.com/docs/guides/auth/auth-mfa) for more details about MFA enforcement.
## What's Next[#](https://supabase.com/blog/mfa-auth-via-rls#whats-next)
For starters, we are looking to support WebAuthn and FIDO2 compliant devices such as Yubikeys. We also hope to allow users to receive email notifications when selected MFA actions are triggered. If you have MFA requirements which are not covered here feel free to write to us at support[at]supabase.io .
We are grateful to our early MFA users for the support and feedback provided throughout this period. In particular, we would like to thank [Fabian Beer](https://madebyfabian.com), [Cogram](https://www.cogram.com), and [Happl](https://happl.com) whose detailed feedback helped to shape our implementation. We would also like to specially thank the community behind the [pquerna/otp](https://github.com/pquerna/otp) and [ajstarks/svgo](https://github.com/ajstarks/svgo) libraries - their work is indispensable to this implementation.
## More Launch Week 6[#](https://supabase.com/blog/mfa-auth-via-rls#more-launch-week-6)
  * [Day 1: New Supabase Docs, built with Next.js](https://supabase.com/blog/new-supabase-docs-built-with-nextjs)
  * [Day 2: Supabase Storage v2: Image resizing and Smart CDN](https://supabase.com/blog/storage-image-resizing-smart-cdn)
  * [Day 4: Supabase Wrappers, a Postgres FDW framework written in Rust](https://supabase.com/blog/postgres-foreign-data-wrappers-rust)
  * [Day 5: Supabase Vault is now in Beta](https://supabase.com/blog/vault-now-in-beta)
  * [Community Day](https://supabase.com/blog/launch-week-6-community-day)
  * [Point in Time Recovery is now available](https://supabase.com/blog/postgres-point-in-time-recovery)
  * [Custom Domain Names are now available](https://supabase.com/blog/custom-domain-names)
  * [Wrap Up: everything we shipped](https://supabase.com/blog/launch-week-6-wrap-up)


Share this article
[](https://twitter.com/intent/tweet?url=https%3A%2F%2Fsupabase.com%2Fblog%2Fmfa-auth-via-rls&text=Multi-factor%20Authentication%20via%20Row%20Level%20Security%20Enforcement)[](https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fsupabase.com%2Fblog%2Fmfa-auth-via-rls&text=Multi-factor%20Authentication%20via%20Row%20Level%20Security%20Enforcement)[](https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fsupabase.com%2Fblog%2Fmfa-auth-via-rls&t=Multi-factor%20Authentication%20via%20Row%20Level%20Security%20Enforcement)
[Last postSupabase Wrappers, a Postgres FDW framework written in Rust15 December 2022](https://supabase.com/blog/postgres-foreign-data-wrappers-rust)
[Next postSupabase Storage v2: Image resizing and Smart CDN13 December 2022](https://supabase.com/blog/storage-image-resizing-smart-cdn)
[launch-week](https://supabase.com/blog/tags/launch-week)[auth](https://supabase.com/blog/tags/auth)[mfa](https://supabase.com/blog/tags/mfa)[saml](https://supabase.com/blog/tags/saml)
On this page
  * [What is MFA?](https://supabase.com/blog/mfa-auth-via-rls#what-is-mfa)
  * [An Overview of TOTP](https://supabase.com/blog/mfa-auth-via-rls#an-overview-of-totp)
  * [MFA Flows: Enrollment and Verification](https://supabase.com/blog/mfa-auth-via-rls#mfa-flows-enrollment-and-verification)
  * [Enforcement via Row Level Security](https://supabase.com/blog/mfa-auth-via-rls#enforcement-via-row-level-security)
  * [What's Next](https://supabase.com/blog/mfa-auth-via-rls#whats-next)
  * [More Launch Week 6](https://supabase.com/blog/mfa-auth-via-rls#more-launch-week-6)


Share this article
[](https://twitter.com/intent/tweet?url=https%3A%2F%2Fsupabase.com%2Fblog%2Fmfa-auth-via-rls&text=Multi-factor%20Authentication%20via%20Row%20Level%20Security%20Enforcement)[](https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fsupabase.com%2Fblog%2Fmfa-auth-via-rls&text=Multi-factor%20Authentication%20via%20Row%20Level%20Security%20Enforcement)[](https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fsupabase.com%2Fblog%2Fmfa-auth-via-rls&t=Multi-factor%20Authentication%20via%20Row%20Level%20Security%20Enforcement)
## Build in a weekend, scale to millions
[Start your project](https://supabase.com/dashboard)[Request a demo](https://supabase.com/contact/sales)
## Footer
We protect your data.[More on Security](https://supabase.com/security)
  * SOC2 Type 2 Certified
  * HIPAA Compliant


[![Supabase Logo](https://supabase.com/_next/image?url=https%3A%2F%2Ffrontend-assets.supabase.com%2Fwww%2Fd218d9190b87%2F_next%2Fstatic%2Fmedia%2Fsupabase-logo-wordmark--light.daaeffd3.png&w=384&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG)![Supabase Logo](https://supabase.com/_next/image?url=https%3A%2F%2Ffrontend-assets.supabase.com%2Fwww%2Fd218d9190b87%2F_next%2Fstatic%2Fmedia%2Fsupabase-logo-wordmark--dark.b36ebb5f.png&w=384&q=75&dpl=dpl_9xPTPeSUKoDuygMmT5sPj6DB4mgG)](https://supabase.com/)
[Twitter](https://twitter.com/supabase)[GitHub](https://github.com/supabase)[Discord](https://discord.supabase.com/)[Youtube](https://youtube.com/c/supabase)
###### Product
  * [Database](https://supabase.com/database)
  * [Auth](https://supabase.com/auth)
  * [Functions](https://supabase.com/edge-functions)
  * [Realtime](https://supabase.com/realtime)
  * [Storage](https://supabase.com/storage)
  * [Vector](https://supabase.com/modules/vector)
  * [Cron](https://supabase.com/modules/cron)
  * [Pricing](https://supabase.com/pricing)
  * [Launch Week](https://supabase.com/launch-week)
  * [AI Builders](https://supabase.com/solutions/ai-builders)


###### Resources
  * [Support](https://supabase.com/support)
  * [System Status](https://status.supabase.com/)
  * [Become a Partner](https://supabase.com/partners)
  * [Integrations](https://supabase.com/partners/integrations)
  * [Brand Assets / Logos](https://supabase.com/brand-assets)
  * [Security and Compliance](https://supabase.com/security)
  * [DPA](https://supabase.com/legal/dpa)
  * [SOC2](https://supabase.com/security)
  * [HIPAA](https://forms.supabase.com/hipaa2)


###### Developers
  * [Documentation](https://supabase.com/docs)
  * [Supabase UI](https://supabase.com/ui)
  * [Changelog](https://supabase.com/changelog)
  * [Contributing](https://github.com/supabase/supabase/blob/master/CONTRIBUTING.md)
  * [Open Source](https://supabase.com/open-source)
  * [SupaSquad](https://supabase.com/supasquad)
  * [DevTo](https://dev.to/supabase)
  * [RSS](https://supabase.com/rss.xml)


###### Company
  * [Blog](https://supabase.com/blog)
  * [Customer Stories](https://supabase.com/customers)
  * [Careers](https://supabase.com/careers)
  * [Company](https://supabase.com/company)
  * [Events & Webinars](https://supabase.com/events)
  * [General Availability](https://supabase.com/ga)
  * [Terms of Service](https://supabase.com/terms)
  * [Privacy Policy](https://supabase.com/privacy)
  * Privacy Settings
  * [Acceptable Use Policy](https://supabase.com/aup)
  * [Support Policy](https://supabase.com/support-policy)
  * [Service Level Agreement](https://supabase.com/sla)
  * [Humans.txt](https://supabase.com/humans.txt)
  * [Lawyers.txt](https://supabase.com/lawyers.txt)
  * [Security.txt](https://supabase.com/.well-known/security.txt)


© Supabase Inc
Toggle theme

